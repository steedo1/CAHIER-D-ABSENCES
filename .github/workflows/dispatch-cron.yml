name: Dispatch Push Cron (CIV 07h–18h)

on:
  schedule:
    # UTC == Abidjan → 07h–18h UTC
    - cron: "*/15 7-18 * * *"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: cron-dispatch-push
  cancel-in-progress: false

jobs:
  call-dispatch:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      # Exemple: https://ton-domaine.xyz/api/push/dispatch
      PROD_CRON_URL: ${{ secrets.PROD_CRON_URL }}
      CRON_SECRET:   ${{ secrets.CRON_SECRET }}
    steps:
      - name: Check secrets presence
        run: |
          test -n "$PROD_CRON_URL" || { echo "Missing PROD_CRON_URL secret"; exit 1; }
          test -n "$CRON_SECRET"   || { echo "Missing CRON_SECRET secret"; exit 1; }

      - name: Call cron endpoint (with debug)
        shell: bash
        run: |
          set -euo pipefail
          echo "POST $PROD_CRON_URL"
          for i in 1 2 3; do
            CODE=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
              -X POST "$PROD_CRON_URL" \
              -H "x-cron-secret: $CRON_SECRET" \
              -H "Content-Type: application/json" \
              --data '{"source":"github-actions"}' || true)
            echo "Attempt #$i → HTTP $CODE"
            echo "----- Response body -----"
            cat /tmp/resp.txt || true
            echo "-------------------------"
            if [[ "$CODE" -ge 200 && "$CODE" -lt 400 ]]; then exit 0; fi
            sleep 5
          done
          echo "Failed after retries (see body above)"; exit 1
