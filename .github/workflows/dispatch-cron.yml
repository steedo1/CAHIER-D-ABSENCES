name: Dispatch Push Cron (CIV 07h–18h)

on:
  schedule:
    # UTC == Abidjan → 07h–18h UTC
    - cron: "*/15 7-18 * * *"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: cron-dispatch-push
  cancel-in-progress: false

jobs:
  call-dispatch:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      # DOIT pointer vers https://www.mon-cahier.com/api/push/dispatch (avec www)
      PROD_CRON_URL: ${{ secrets.PROD_CRON_URL }}
      CRON_SECRET:   ${{ secrets.CRON_SECRET }}
    steps:
      - name: Check secrets presence
        run: |
          test -n "$PROD_CRON_URL" || { echo "::error::Missing PROD_CRON_URL secret"; exit 1; }
          test -n "$CRON_SECRET"   || { echo "::error::Missing CRON_SECRET secret"; exit 1; }

      - name: Call cron endpoint (follow redirects, 2xx only)
        shell: bash
        run: |
          set -euo pipefail
          set +x
          URL="$(echo "$PROD_CRON_URL" | tr -d '[:space:]')"
          HDR_X="x-cron-secret: $CRON_SECRET"
          PAYLOAD='{"source":"github-actions"}'

          echo "POST $URL (redirections autorisées)"
          for i in 1 2 3; do
            CODE=$(curl -sS -L \
              --connect-timeout 10 --max-time 25 \
              -o /tmp/resp.txt -w "%{http_code}" \
              -X POST "$URL" \
              -H "$HDR_X" \
              -H "Content-Type: application/json" \
              -H "User-Agent: gh-actions-push-cron" \
              --data "$PAYLOAD" || true)

            echo "Attempt #$i → HTTP $CODE"
            echo "----- Response body (2KB max) -----"
            head -c 2048 /tmp/resp.txt || true; echo
            echo "-----------------------------------"

            [[ "$CODE" =~ ^2..$ ]] && exit 0
            sleep 5
          done

          echo "::error::Failed after retries (see body above)"; exit 1
