name: Dispatch Push Cron (tests toutes les 5 min)

on:
  schedule:
    - cron: "*/5 * * * *"   # ⬅️ élargie pour les tests
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: cron-dispatch-push
  cancel-in-progress: false

jobs:
  call-dispatch:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      # Exemple attendu: https://mon-cahier.com/api/push/dispatch   (⚠️ sans www)
      PROD_CRON_URL: ${{ secrets.PROD_CRON_URL }}
      CRON_SECRET:   ${{ secrets.CRON_SECRET }}
    steps:
      - name: Check secrets presence
        run: |
          test -n "$PROD_CRON_URL" || { echo "::error::Missing PROD_CRON_URL secret"; exit 1; }
          test -n "$CRON_SECRET"   || { echo "::error::Missing CRON_SECRET secret"; exit 1; }

      - name: Call cron endpoint (follow redirects, keep POST)
        shell: bash
        run: |
          set -euo pipefail
          set +x  # éviter d'imprimer les secrets
          call() {
            local URL="$1"
            echo "POST $URL"
            CODE=$(curl -sS -L --post301 --post302 \
              --connect-timeout 10 --max-time 25 \
              -o /tmp/resp.txt -w "%{http_code}" \
              -X POST "$URL" \
              -H "x-cron-secret: $CRON_SECRET" \
              -H "Content-Type: application/json" \
              -H "User-Agent: gh-actions-push-cron" \
              --data '{"source":"github-actions"}' || true)
            echo "HTTP $CODE"
            echo "----- Response body (2KB max) -----"
            head -c 2048 /tmp/resp.txt || true; echo
            echo "-----------------------------------"
            [[ "$CODE" -ge 200 && "$CODE" -lt 300 ]]
          }

          URL="$(echo "$PROD_CRON_URL" | tr -d '[:space:]')"
          # 1) essai direct
          if call "$URL"; then exit 0; fi

          # 2) fallback apex<->www (si mauvais host)
          SWAP="$URL"
          SWAP="${SWAP/https:\/\/www./https:\/\/}"
          if [ "$SWAP" = "$URL" ]; then SWAP="${URL/https:\/\/https:\/\//https:\/\/www.}"; fi
          echo "Retry with swapped host: $SWAP"
          if call "$SWAP"; then exit 0; fi

          echo "::error::Failed after retries (see body above)"; exit 1
